
{% extends "base.html" %}
{% load static %}
{% block content %}

{% if user.is_authenticated %}
    
    {# â”€â”€â”€ ê²€ìƒ‰ë°” ì¶”ê°€ â”€â”€â”€ #}
    <div class="search-bar" style="margin-bottom:16px;">  <!-- â† ìˆ˜ì • -->
      <input
        type="text"
        id="searchInput"
        placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        style="padding:8px; width:200px;"
      >
      <button id="searchBtn" class="btn">ê²€ìƒ‰</button>
    </div>
    {# â”€â”€â”€ ê²€ìƒ‰ë°”ë â”€â”€â”€ #}

    <div class="todocontainer"></div>
    <div class="pagination"></div>
    <div class="list-btn">
      <button class="todoCreate" id="createBtn">Todo ë“±ë¡í•˜ê¸°</button>
    </div>
{% else %}
    <div style="max-width: 600px; margin: 40px auto; text-align: center;">
        <p>í•  ì¼ ëª©ë¡ì€ ë¡œê·¸ì¸ í›„ì— í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
{% endif %}


<script>
let currentPage = 1;  //  í˜„ì¬ í˜ì´ì§€ë¥¼ ê¸°ì–µí•˜ëŠ” ì „ì—­ ë³€ìˆ˜
let currentSearch = "";   // âœ…â† ìˆ˜ì •: ê²€ìƒ‰ì–´ë¥¼ ê¸°ì–µí•  ì „ì—­ ë³€ìˆ˜

// 1. ë¬¸ì„œê°€ ì™„ì „íˆ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', init);

// 2. ì´ˆê¸°í™”: UI ì´ë²¤íŠ¸ ì—°ê²° ë° ì²« í˜ì´ì§€ Todo ëª©ë¡ ë¡œë“œ
function init() {
    UIEvents(); // 2-1. ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    loadTodoList(1); // 2-2. ì²« í˜ì´ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
}

// 2-1. UI ì´ë²¤íŠ¸ ë°”ì¸ë”©: "Todo ë“±ë¡í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™
function UIEvents() {
    document.getElementById('createBtn')
        .addEventListener('click', onCreateClick);

     /* â”€â”€â”€ âœ… ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© â”€â”€â”€ */ 
    document.getElementById('searchBtn')
        .addEventListener('click', () => {
            currentSearch = document.getElementById('searchInput').value.trim();  // â† ìˆ˜ì •
            loadTodoList(1);
    });
    /*
    1. 'searchBtn'ì´ë¼ëŠ” IDë¥¼ ê°€ì§„ ë²„íŠ¼ ìš”ì†Œë¥¼ ì°¾ëŠ”ë‹¤

    2. ê·¸ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•œë‹¤:
        - ì‚¬ìš©ìê°€ í´ë¦­í•˜ë©´ ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰:
            a. 'searchInput'ì´ë¼ëŠ” IDë¥¼ ê°€ì§„ ì…ë ¥ì°½ì˜ ê°’ì„ ì½ì–´ì˜¨ë‹¤
            b. ì•ë’¤ ê³µë°±ì„ ì œê±°í•œ ê°’ì„ currentSearch ë³€ìˆ˜ì— ì €ì¥í•œë‹¤
            c. í˜ì´ì§€ ë²ˆí˜¸ 1ë²ˆì„ ê¸°ì¤€ìœ¼ë¡œ í•  ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤
            1í˜ì´ì§€ë¶€í„° í•  ì¼ ëª©ë¡(Todo ë¦¬ìŠ¤íŠ¸)ì„ ì„œë²„ì—ì„œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•œ í•¨ìˆ˜ í˜¸ì¶œì…ë‹ˆë‹¤. ì¬ìš”ì²­ ê°œë…
    */    
}




// 2-1-1. ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ /todo/create/ë¡œ ì´ë™
function onCreateClick() {
    window.location.href = '/todo/create/';
}

// 3. ì„œë²„ì—ì„œ Todo ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadTodoList(page) {
    currentPage = page; 
    fetchTodoData(page, currentSearch)   //âœ… â† ìˆ˜ì •: search ì¸ì ì „ë‹¬
        .then(data => {
            const todos = extractTodoArray(data);  
            renderTodoList(todos);  
            renderPagination(data, page); 
        })
        .catch(err => {
            if (err.response?.status === 404 && err.response.data.detail === 'Invalid page.') {
                // ì˜ëª»ëœ í˜ì´ì§€ â†’ ì²« í˜ì´ì§€ë¡œ ë³µê·€
                console.warn('ì˜ëª»ëœ í˜ì´ì§€ ìš”ì²­, ì²« í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                return loadTodoList(1);
            }
            console.error('ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err);
        });
} 

// 3-1. axiosë¥¼ ì´ìš©í•´ ì„œë²„ë¡œë¶€í„° íŠ¹ì • í˜ì´ì§€ì˜ Todo ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
function fetchTodoData(page, search="") {  // âœ… â† ìˆ˜ì •: search íŒŒë¼ë¯¸í„°
    return axiosInstance
        //.get(`/todo/viewsets/view/?page=${currentPage}`) 
        .get(`/todo/viewsets/view/`, { 
            params: { page, search }  // âœ… â† ìˆ˜ì •: search ì¿¼ë¦¬ í¬í•¨
        })
        .then(res => {
            console.log("ì‘ë‹µ ë°ì´í„°:", res.data);
            return res.data;
        });    
} 

// 3-2. API ì‘ë‹µ í˜•ì‹ì— ë”°ë¼ Todo ë°°ì—´ ì¶”ì¶œ
function extractTodoArray(data) {
    // 1) CustomPageNumberPagination ì‚¬ìš© ì‹œ
    if (Array.isArray(data.data)) {
        return data.data;
    }
    // 2) ê¸°ë³¸ PageNumberPagination ì‚¬ìš© ì‹œ
    if (Array.isArray(data.results)) {
        return data.results;
    }
    // 3) Pagination ì—†ì´ ìˆœìˆ˜ ë°°ì—´ ë¦¬í„´ ì‹œ
    if (Array.isArray(data)) {
        return data;
    }
    return [];
}

// 3-3. ì¶”ì¶œëœ Todo í•­ëª©ë“¤ì„ í™”ë©´ì— ë Œë”ë§
function renderTodoList(todos) {
    const container = document.querySelector('.todocontainer');
    container.innerHTML = '';
    todos.forEach(todo => {
        console.log("todo.id í™•ì¸:", todo.id); // pkí™•ì¸
        container.appendChild(createTodoElement(todo))
    });
} 

// 3-3-1. ë‹¨ì¼ Todo ê°ì²´ë¥¼ HTML ìš”ì†Œë¡œ ìƒì„±
function createTodoElement(todo) {
    const div = document.createElement('div');
    div.className = 'todo-item';

    // ì™„ë£Œëœ í•­ëª©ì´ë©´ ë°‘ì¤„ ì ìš©
    if (todo.complete) {
        div.classList.add('completed');
    }

    // ëª©ë¡ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™
    div.addEventListener('click', () => detailView(todo.id));

    // HTML ë‚´ìš© ì„¤ì •
    div.innerHTML = `
        <p><strong>Name:</strong> ${todo.name}</p>
        <p><strong>Description:</strong> ${todo.description}</p>
        <p><strong>Complete:</strong> ${todo.complete}</p>
        <p><strong>Completed At:</strong> ${datetimeToString(todo.completed_at)}</p>
        <p><strong>Experience Points:</strong> ${todo.exp}</p>
        <p><strong>image:</strong><br> ${todo.image ? `<img src="${todo.image}" alt="${todo.name}" width="150">` : ''}</p>
            
        <!-- âœ… ì†Œì…œ ê¸°ëŠ¥ UI ì¶”ê°€ -->
        <div class="todo-interactions">
            
            <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
            <button class="social-btn likeBtn" data-id="${todo.id}"> 
                <span class="icon">${todo.is_liked ? 'ğŸ’”' : 'â¤ï¸'}</span> 
                <span class="count">${todo.like_count}</span>           
            </button>

            <!-- ë¶ë§ˆí¬ ë²„íŠ¼ -->
            <button class="social-btn bookmarkBtn" data-id="${todo.id}"> 
                <span class="icon">ğŸ”–</span>                                
                <span class="count">${todo.bookmark_count}</span>           
            </button>

            <!-- ëŒ“ê¸€ ë³´ê¸°/í† ê¸€ ë²„íŠ¼ -->
            <button class="social-btn commentToggleBtn">                  
                <span class="icon">ğŸ’¬</span>                                 
                <span class="count">${todo.comment_count || 0}</span>       
            </button>
        </div>

        <!-- ëŒ“ê¸€ ë°•ìŠ¤ëŠ” interactions ë°”ê¹¥ìœ¼ë¡œ ëºìŠµë‹ˆë‹¤ -->
        <div class="commentBox" style="display:none;">                   
            <ul class="commentList"></ul>
            <input type="text" class="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button class="commentSubmit">ë“±ë¡</button>
        </div>

        <!-- ì™„ë£Œ ë²„íŠ¼ì€ interactions ì•ˆìœ¼ë¡œ ì´ë™ì‹œí‚¤ê³  ì˜¤ë¥¸ìª½ ì •ë ¬ -->
        <div class="todo-interactions">                                 
            <button class="completeBtn">ì™„ë£Œ</button>                    
        </div>
    `;

    // ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì™„ë£Œ API í˜¸ì¶œ
    div.querySelector('.completeBtn')
        .addEventListener('click', e => {
            e.stopPropagation();
            toComplete(todo.id).then(() => {
                loadTodoList(currentPage); // âœ… ì™„ë£Œ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì„œë²„ì— ì €ì¥ë§Œ í•˜ì§€ ë§ê³ , todoList ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê²Œí•˜ê¸°
        });
    });
    
    // âœ… ì¢‹ì•„ìš” ë²„íŠ¼ ì´ë²¤íŠ¸
    div.querySelectorAll('.likeBtn').forEach(btn => { // 1. .likeBtn í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ëª¨ë“  ìš”ì†Œë¥¼ ì„ íƒí•˜ì—¬ ë°˜ë³µ
        btn.addEventListener('click', function (e) { // 2. ê° ë²„íŠ¼(btn)ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            e.stopPropagation(); // 3. í´ë¦­ ì´ë²¤íŠ¸ê°€ ë¶€ëª¨ ìš”ì†Œë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë§‰ìŒ (ë²„ë¸”ë§ ë°©ì§€)
            const id = this.dataset.id; // 4. ì´ ë²„íŠ¼ì— data-id ì†ì„±ìœ¼ë¡œ ì €ì¥ëœ ê°’ì„ ê°€ì ¸ì˜´ (ë³´í†µ Todoì˜ ID)
            console.log("ğŸ‘ ì¢‹ì•„ìš” í´ë¦­, id =", id); // 5. ì½˜ì†”ì— í´ë¦­ëœ ì•„ì´í…œì˜ IDë¥¼ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            toggleLike(btn.dataset.id); // 6. ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜ ì‹¤í–‰ (í•´ë‹¹ IDì˜ Todoì— ëŒ€í•´ ì¢‹ì•„ìš” ì²˜ë¦¬)
        });
    });

    // âœ… ë¶ë§ˆí¬ ë²„íŠ¼ ì´ë²¤íŠ¸
    div.querySelector('.bookmarkBtn')
        .addEventListener('click', function(e) {
            e.stopPropagation();
            console.log("ë¶ë§ˆí¬ í´ë¦­, id =", id);
            const id = this.dataset.id;
            toggleBookmark(id);
            //console.log("ë°ì´í„°ì…‹:", id); 
        });

    // âœ… ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸
    div.querySelector('.commentSubmit')
        .addEventListener('click', e => {
            e.stopPropagation();
            const commentInput = div.querySelector('.commentInput');
            const content = commentInput.value;
            if (content.trim()) {
                postComment(todo.id, content);
                commentInput.value = ''; 
            }
        });

    // âœ… ëŒ“ê¸€ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
    div.querySelector('.commentToggleBtn')
        .addEventListener('click', e => {
            e.stopPropagation();
            const commentBox = div.querySelector('.commentBox');
            commentBox.style.display = (commentBox.style.display === 'none') ? 'block' : 'none';
            // ì›í•œë‹¤ë©´ ëŒ“ê¸€ ëª©ë¡ fetchí•´ì„œ ì¶œë ¥ ê°€ëŠ¥
            loadComments(todo.id, div.querySelector('.commentList'));
        });

    // âœ… ì¶”ê°€! ëŒ“ê¸€ ì…ë ¥ì°½ í´ë¦­ ì‹œ ìƒì„¸ë³´ê¸° ì´ë™ ë°©ì§€
    div.querySelector('.commentInput')
        .addEventListener('click', e => {
            e.stopPropagation();
        });    

    return div;
}

// âœ… ì¢‹ì•„ìš” í† ê¸€
function toggleLike(id) {
  axiosInstance.post(`/api/interaction/likes/${id}/toggle/`)
    .then(res => { 
      console.log("ì¢‹ì•„ìš” ì‘ë‹µ:", res.data);
      const { is_liked, like_count } = res.data;

      // 1.  ì•„ì´ì½˜ ë³€ê²½ (ìˆë‹¤ë©´)
      const btn = document.querySelector(`.likeBtn[data-id="${id}"]`);
      if (btn) {
        btn.innerText = is_liked ? "ğŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ" : "â¤ï¸ ì¢‹ì•„ìš”";
      }

      // 2. ì¢‹ì•„ìš” ê°œìˆ˜ ê°±ì‹ 
      const countSpan = document.querySelector(`.like-count[data-id="${id}"]`);
      if (countSpan) {
        countSpan.innerText = like_count;
      }
    })
    .catch(err => {
      console.error(" ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:", err);
    });
}

// âœ… ë¶ë§ˆí¬ í† ê¸€
function toggleBookmark(id) {
  axiosInstance.post(`/api/interaction/bookmarks/${id}/toggle/`)
    .then(res => {
      console.log('ë¶ë§ˆí¬ ì‘ë‹µ:', res.data);
      const { is_bookmarked, bookmark_count } = res.data;

      const btn  = document.querySelector(`.bookmarkBtn[data-id="${id}"]`);
      const span = document.querySelector(`.bookmark-count[data-id="${id}"]`);

      if (btn)  btn.innerText  = is_bookmarked ? 'ë¶ë§ˆí¬ í•´ì§€' : 'ğŸ”– ë¶ë§ˆí¬ í•˜ê¸°';
      if (span) span.innerText = bookmark_count;
    })
    .catch(err => console.error(' ë¶ë§ˆí¬ í† ê¸€ ì‹¤íŒ¨:', err));
}

// âœ… ëŒ“ê¸€ ë‹¬ê¸°
function postComment(todoId, content) {
  if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");

  axiosInstance.post("/api/interaction/comments/", {
    todo_pk: todoId,       // perform_createì—ì„œ Todoë¡œ ì²˜ë¦¬
    content: content       // serializerì—ì„œ ìš”êµ¬
  }).then(() => {
    loadComments(todoId, document.querySelector('.commentList'));
  }).catch(error => {
    console.error(" ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", error.response?.data || error);
    alert(" ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:\n" +
          JSON.stringify(error.response?.data, null, 2));
  });
}


// âœ… ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
function loadComments(todoId, listElement) {
  axiosInstance.get(`/api/interaction/comments/`, { params: { todo_pk: todoId } })
    .then(res => {
      const payload = Array.isArray(res.data)
        ? res.data
        : Array.isArray(res.data.results)
          ? res.data.results
          : (res.data.data || []);

      listElement.innerHTML = '';
      payload.forEach(c => {
        const li = document.createElement('li');
        li.innerText = `${c.user.username || c.username}: ${c.content}`;
        listElement.appendChild(li);
      });
    })
    .catch(err => console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', err));
}


// 3-3-2. ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ Todo í•­ëª©ì„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
function toComplete(id) {
    axiosInstance.patch(`/todo/viewsets/view/${id}/`, { complete: true })
        .then(() => loadTodoList(currentPage))  
        .catch(err => console.error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', err));
}


// 3-3-3. ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
function detailView(id) {
    window.location.href = `/todo/detail/${id}/`;
}


// 3-4. í˜ì´ì§€ë„¤ì´ì…˜ êµ¬ì„± (â† ì´ì „, 1 2 3, â†’ ë‹¤ìŒ)
function renderPagination(data, currentPage) {
    const wrapper = document.querySelector('.pagination');
    wrapper.innerHTML = '';

    const totalPages = data.page_count;

     // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
    const prevBtn = document.createElement('button');
    prevBtn.innerText = 'â€¹';
    prevBtn.disabled = !data.previous; 
    //data.previousëŠ” Django REST Framework(DRF)ì—ì„œ ê¸°ë³¸ ì œê³µí•˜ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ ì†ì„± ì´ë¦„ì…ë‹ˆë‹¤.
    prevBtn.addEventListener('click', () => loadTodoList(currentPage - 1));
    wrapper.appendChild(prevBtn);

    // ê°œë³„ í˜ì´ì§€ ë²„íŠ¼ë“¤ ìƒì„±
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        if (i === currentPage) { //ì—„ê²©í•œë¹„êµ
            btn.disabled = true;
            btn.classList.add('active');  // CSSë¡œ .active ìŠ¤íƒ€ì¼ ì§€ì •
        }
        btn.addEventListener('click', () => loadTodoList(i)); // âœ…ì˜¤íƒ€
        wrapper.appendChild(btn);
    }

    // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
    const nextBtn = document.createElement('button');
    nextBtn.innerText = 'â€º';
    nextBtn.disabled = !data.next;
    nextBtn.addEventListener('click', () => loadTodoList(currentPage + 1)); // âœ…ì˜¤íƒ€
    wrapper.appendChild(nextBtn);
}
</script> 

{% endblock %}